# üè¶ Entendendo o Sistema de Compra Programada ‚Äî Explica√ß√£o para Leigos

---

## A Analogia: A Vaquinha do Churrasco ü•©

Imagine o seguinte cen√°rio pra entender o sistema inteiro:

**Voc√™ e seus amigos querem comprar carne todo m√™s, mas ningu√©m quer ir ao a√ßougue sozinho.** Ent√£o voc√™s combinam:

1. Cada um d√° um valor por m√™s (Jo√£o d√° R$100, Maria d√° R$200)
2. Um organizador junta tudo (R$300) e vai ao a√ßougue
3. O organizador compra a carne em atacado (mais barato por ser mais quantidade)
4. Depois distribui a carne pra cada um, proporcional ao que pagou
5. Se sobrar um peda√ßo que n√£o d√° pra dividir certinho, guarda pro m√™s que vem

**Isso √© EXATAMENTE o que o sistema faz, mas com a√ß√µes ao inv√©s de carne.**

---

## O que √© a Ita√∫ Corretora?

A Ita√∫ Corretora √© uma empresa que **compra e vende a√ß√µes na bolsa** em nome dos clientes. Como se fosse o "organizador do churrasco" ‚Äî ela faz o trabalho de ir √† bolsa pra voc√™.

## O que √© o produto "Compra Programada"?

√â um plano autom√°tico:
- Voc√™ diz: "quero investir R$3.000 por m√™s"
- A corretora diz: "beleza, todo m√™s eu compro a√ß√µes pra voc√™ automaticamente"
- As a√ß√µes s√£o escolhidas por especialistas (a equipe de "Research")
- Eles escolhem 5 a√ß√µes que acham boas ‚Üí chamam de **"Top Five"**

---

## Os Personagens do Sistema

### üßë O Cliente
Uma pessoa que adere ao produto. Ela diz:
- Meu nome, CPF, email
- Quanto quero investir por m√™s (ex: R$3.000)

### üè¢ A Corretora (Conta Master)
√â a "organizadora". Ela:
- Junta o dinheiro de todos os clientes
- Compra as a√ß√µes de uma vez s√≥ (mais eficiente)
- Distribui as a√ß√µes para cada cliente

### üë®‚Äçüíº O Administrador
√â a equipe de Research. Eles decidem:
- Quais 5 a√ß√µes comprar (a cesta "Top Five")
- Quanto % colocar em cada uma (ex: 30% em PETR4, 25% em VALE3...)

---

## Conceitos Financeiros (Simplificados)

### O que √© uma A√á√ÉO?
√â um pedacinho de uma empresa. Se voc√™ compra 1 a√ß√£o da Petrobras (PETR4), voc√™ √© "dono" de um pedacinho min√∫sculo da Petrobras. Se a empresa vai bem, sua a√ß√£o vale mais. Se vai mal, vale menos.

### O que √© um TICKER?
√â o "apelido" da a√ß√£o na bolsa. Exemplos:
- **PETR4** = Petrobras
- **VALE3** = Vale
- **ITUB4** = Ita√∫ Unibanco
- **BBDC4** = Bradesco
- **WEGE3** = WEG

### O que √© COTA√á√ÉO?
√â o pre√ßo atual de uma a√ß√£o. Muda o tempo todo durante o dia. 
- **Cota√ß√£o de fechamento** = o √∫ltimo pre√ßo do dia (√© esse que usamos)

### Lote Padr√£o vs. Mercado Fracion√°rio

Na bolsa, normalmente voc√™ compra a√ß√µes em **pacotes de 100** (lote padr√£o).

Pense assim: √© como comprar ovos. No atacado, vc compra caixas de 30. Mas se vc quer s√≥ 12, compra a d√∫zia avulsa (mercado fracion√°rio).

- **Lote padr√£o:** compra de 100 em 100. Ticker normal: `PETR4`
- **Fracion√°rio:** compra de 1 a 99. Ticker com F: `PETR4F`

**Exemplo:** Se preciso comprar 350 a√ß√µes de PETR4:
- 3 lotes de 100 = 300 via `PETR4` (lote padr√£o)
- 50 avulsas via `PETR4F` (fracion√°rio)

### Pre√ßo M√©dio
Voc√™ comprou PETR4 em momentos diferentes:
- Janeiro: 10 a√ß√µes a R$35
- Fevereiro: 10 a√ß√µes a R$40

Qual foi seu pre√ßo m√©dio? 
```
(10 x 35 + 10 x 40) / (10 + 10) = 750 / 20 = R$37,50
```

Isso √© importante pra saber se voc√™ t√° **ganhando ou perdendo dinheiro**.

### IR Dedo-Duro (Imposto de Renda)
Toda vez que algu√©m compra/vende a√ß√µes, o governo quer saber. A corretora ret√©m **0,005%** do valor da opera√ß√£o automaticamente. √â um valor ridiculamente pequeno (R$0,01 numa opera√ß√£o de R$200), mas serve como "dedo-duro" ‚Äî avisa a Receita Federal que houve uma opera√ß√£o.

### Regra dos R$20.000
Se uma pessoa vende **mais de R$20.000 em a√ß√µes no mesmo m√™s**, ela paga **20% de imposto sobre o LUCRO**. Se vendeu menos de R$20.000, **n√£o paga nada**.

---

## O Fluxo Completo ‚Äî Passo a Passo

### ETAPA 1: Ades√£o do Cliente

O Jo√£o liga pra corretora e diz: "quero entrar no plano".

O sistema:
1. Cadastra o Jo√£o (nome, CPF, email, valor mensal: R$3.000)
2. Cria uma **Conta Gr√°fica Filhote** pra ele (√© como "abrir uma conta")
3. Cria uma **Cust√≥dia Filhote** vazia (a "prateleira" onde v√£o ficar as a√ß√µes dele)

**Entidades envolvidas:**
- [Cliente](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/Cliente.cs#3-17) ‚Üí os dados do Jo√£o
- [ContaGrafica](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/ContaGrafica.cs#3-14) ‚Üí a conta de registro dele (tipo = "FILHOTE")
- [CustodiaFilhote](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/CustodiaFilhote.cs#3-13) ‚Üí inicialmente vazia (0 a√ß√µes)

---

### ETAPA 2: A Cesta Top Five

O administrador cadastra quais a√ß√µes comprar:

| A√ß√£o | Percentual |
|---|---|
| PETR4 | 30% |
| VALE3 | 25% |
| ITUB4 | 20% |
| BBDC4 | 15% |
| WEGE3 | 10% |

Isso significa: de cada R$100 investidos, R$30 v√£o pra Petrobras, R$25 pra Vale, etc.

**Entidades envolvidas:**
- [CestaRecomendacao](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/CestaRecomendacao.cs#3-13) ‚Üí "Top Five - Fevereiro 2026", ativa = true
- [ItemCesta](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/ItemCesta.cs#3-12) ‚Üí 5 registros, um por a√ß√£o (PETR4/30%, VALE3/25%, etc.)

---

### ETAPA 3: Motor de Compra (O CORA√á√ÉO do Sistema)

**QUANDO acontece?** Nos dias **5, 15 e 25** de cada m√™s (se cair no fim de semana, vai pra segunda-feira).

**POR QU√ä 3 vezes?** O valor mensal √© dividido em 3 parcelas. Se o Jo√£o investe R$3.000/m√™s, s√£o R$1.000 a cada data.

#### Exemplo concreto ‚Äî Dia 5 do m√™s:

**Clientes ativos:**
- Jo√£o: R$3.000/m√™s ‚Üí 1/3 = **R$1.000**
- Maria: R$6.000/m√™s ‚Üí 1/3 = **R$2.000**

**Total consolidado: R$3.000** (a corretora junta tudo)

**Passo 1 ‚Äî Calcular quanto comprar de cada a√ß√£o:**

| A√ß√£o | % da Cesta | Valor | Cota√ß√£o | Qtd a Comprar |
|---|---|---|---|---|
| PETR4 | 30% | R$900 | R$35 | TRUNCAR(900/35) = **25** |
| VALE3 | 25% | R$750 | R$62 | TRUNCAR(750/62) = **12** |
| ITUB4 | 20% | R$600 | R$30 | TRUNCAR(600/30) = **20** |
| BBDC4 | 15% | R$450 | R$15 | TRUNCAR(450/15) = **30** |
| WEGE3 | 10% | R$300 | R$40 | TRUNCAR(300/40) = **7** |

> **TRUNCAR** = arredondar pra baixo (porque n√£o d√° pra comprar 0,5 a√ß√£o)

**Passo 2 ‚Äî Verificar se tem sobra da √∫ltima vez (cust√≥dia master):**

Se da vez anterior sobraram 2 a√ß√µes de PETR4 na conta master, a corretora **n√£o precisa comprar** essas 2. Compra 25 - 2 = 23.

**Passo 3 ‚Äî Comprar na conta master:**

A corretora compra tudo de uma vez. 

**Entidades envolvidas:**
- [OrdemCompra](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/OrdemCompra.cs#3-14) ‚Üí registro da compra (ticker, quantidade, pre√ßo, valor total)
- [CustodiaMaster](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/CustodiaMaster.cs#3-11) ‚Üí verifica sobras anteriores

**Passo 4 ‚Äî Distribuir para cada cliente (RATEIO):**

Total a distribuir: 25 a√ß√µes de PETR4
- Jo√£o: 1.000/3.000 = **33,3%** ‚Üí TRUNCAR(25 √ó 0,333) = **8 a√ß√µes**
- Maria: 2.000/3.000 = **66,7%** ‚Üí TRUNCAR(25 √ó 0,667) = **16 a√ß√µes**
- Total distribu√≠do: 8 + 16 = 24
- **Sobra na master: 1 a√ß√£o** (25 - 24 = 1)

**Entidades envolvidas:**
- [Distribuicao](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/Distribuicao.cs#3-15) ‚Üí "8 a√ß√µes de PETR4 ‚Üí Jo√£o, dia 05/02"
- [CustodiaFilhote](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/CustodiaFilhote.cs#3-13) ‚Üí atualiza a posi√ß√£o do Jo√£o (agora tem 8 PETR4)
- [CustodiaMaster](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/CustodiaMaster.cs#3-11) ‚Üí guarda a sobra (1 PETR4)

**Passo 5 ‚Äî Atualizar pre√ßo m√©dio:**

Se o Jo√£o j√° tinha 10 PETR4 com PM de R$33:
```
Novo PM = (10 √ó 33 + 8 √ó 35) / (10 + 8) = (330 + 280) / 18 = R$33,89
```

**Passo 6 ‚Äî IR Dedo-Duro (publicar no Kafka):**

A cada distribui√ß√£o, calcula 0,005% e manda pro Kafka:
```
Jo√£o recebeu 8 PETR4 √ó R$35 = R$280
IR dedo-duro = R$280 √ó 0,00005 = R$0,014 ‚Üí R$0,01
```

Manda uma mensagem pro Kafka com: "Jo√£o, CPF tal, 8 PETR4, IR = R$0,01"

---

### ETAPA 4: Rebalanceamento

Existem **2 motivos** pra rebalancear:

#### Motivo A: O administrador mudou a cesta

A cesta era:
```
PETR4(30%) | VALE3(25%) | ITUB4(20%) | BBDC4(15%) | WEGE3(10%)
```
Virou:
```
PETR4(25%) | VALE3(20%) | ITUB4(20%) | ABEV3(20%) | RENT3(15%)
```

O que mudou?
- BBDC4 **saiu** ‚Üí precisa VENDER todas as BBDC4 de todos os clientes
- WEGE3 **saiu** ‚Üí precisa VENDER todas as WEGE3 de todos os clientes
- ABEV3 **entrou** ‚Üí precisa COMPRAR com o dinheiro das vendas
- RENT3 **entrou** ‚Üí precisa COMPRAR com o dinheiro das vendas
- PETR4 mudou de 30% pra 25% ‚Üí vender um pouco

#### Motivo B: Desvio de propor√ß√£o

Se PETR4 deveria ser 30% da carteira do Jo√£o, mas subiu tanto que agora √© 45%, o sistema vende um pouco de PETR4 e compra mais dos que est√£o abaixo.

√â como manter o equil√≠brio.

#### Regra de IR no rebalanceamento:

Quando vende a√ß√µes, verifica:
- Somou todas as vendas do m√™s do cliente
- Se total de vendas > R$20.000 ‚Üí cobra 20% sobre o lucro
- Se total de vendas ‚â§ R$20.000 ‚Üí isento

---

### ETAPA 5: Consultar Carteira

O cliente quer ver como est√£o seus investimentos. O sistema mostra:

```
CARTEIRA DO JO√ÉO
Investido: R$6.000 | Valor atual: R$6.450 | Lucro: +R$450 (+7,5%)

A√ß√£o  | Qtd | PM    | Atual | Valor  | Lucro
PETR4 | 24  | 35,50 | 37,00 | 888,00 | +36,00
VALE3 | 12  | 60,00 | 65,00 | 780,00 | +60,00
...
```

O Lucro/Preju√≠zo (P/L) de cada a√ß√£o:
```
P/L = (Cota√ß√£o Atual - Pre√ßo M√©dio) √ó Quantidade
PETR4: (37,00 - 35,50) √ó 24 = R$36,00 de lucro
```

---

## Mapeamento: Entidade ‚Üî Conceito de Neg√≥cio

| Entidade no c√≥digo | O que √© no mundo real | Analogia da vaquinha |
|---|---|---|
| [Cliente](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/Cliente.cs#3-17) | Investidor (Jo√£o) | Participante da vaquinha |
| [ContaGrafica](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/ContaGrafica.cs#3-14) | Registro de quem √© dono do qu√™ | Lista com nome de cada participante |
| [CustodiaFilhote](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/CustodiaFilhote.cs#3-13) | "Prateleira" do cliente com suas a√ß√µes | Saco de carne do Jo√£o na geladeira |
| [CustodiaMaster](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/CustodiaMaster.cs#3-11) | Sobras na conta da corretora | Peda√ßo que sobrou e n√£o deu pra dividir |
| [CestaRecomendacao](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/CestaRecomendacao.cs#3-13) | A lista "Top Five" | O card√°pio do churrasco |
| [ItemCesta](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/ItemCesta.cs#3-12) | Cada a√ß√£o na lista (PETR4/30%) | Cada tipo de carne (picanha 30%, costela 25%...) |
| [OrdemCompra](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/OrdemCompra.cs#3-14) | A ida ao a√ßougue (compra consolidada) | O organizador foi ao atacado |
| [Distribuicao](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/Distribuicao.cs#3-15) | Dividir a carne | "Jo√£o leva 8 bifes, Maria leva 16 bifes" |
| [CotacaoB3](file:///c:/Users/jcalbuquerque/Desktop/it-test/index5/Index5/Index5.Domain/Entities/CotacaoB3.cs#3-19) | Pre√ßo do dia na bolsa | Pre√ßo da carne no mercado hoje |

---

## Diagrama de Fluxo (Texto)

```
ADMINISTRADOR cadastra a cesta Top Five (5 a√ß√µes + %)
         ‚Üì
CLIENTE adere ‚Üí cria ContaGr√°fica + Cust√≥diaFilhote
         ‚Üì
DIA 5/15/25 DO M√äS ‚Üí Motor de Compra dispara
         ‚Üì
Junta 1/3 do aporte de TODOS os clientes ativos
         ‚Üì
Calcula quanto comprar de cada a√ß√£o (valor √ó % √∑ cota√ß√£o)
         ‚Üì
Verifica sobras na Cust√≥dia Master ‚Üí desconta
         ‚Üì
Compra tudo de uma vez na Conta Master
         ‚Üì
Distribui proporcionalmente pra cada Cust√≥dia Filhote
         ‚Üì
Sobras ficam na Cust√≥dia Master
         ‚Üì
Calcula IR dedo-duro ‚Üí publica no Kafka
         ‚Üì
Atualiza pre√ßo m√©dio de cada cliente
```

---

## 10 Pontos-Chave para o V√≠deo

1. **O sistema automatiza investimento recorrente** em 5 a√ß√µes escolhidas por especialistas
2. **Compra consolidada** = a corretora compra tudo junto (mais eficiente que cada um ir √† bolsa)
3. **Distribui√ß√£o proporcional** = quem paga mais, recebe mais a√ß√µes
4. **Res√≠duo** = sobra de arredondamento fica na master pra pr√≥xima rodada
5. **Pre√ßo m√©dio** = m√©dia ponderada de todas as compras, recalculado a cada compra
6. **Lote padr√£o (100) + fracion√°rio** = otimiza custos dividindo entre os dois mercados
7. **Rebalanceamento** = ajusta a carteira quando a cesta muda ou quando desvia muito
8. **IR dedo-duro (0,005%)** = publicado no Kafka como evento ass√≠ncrono
9. **Regra dos R$20k** = isento de IR se vendas no m√™s < R$20.000
10. **Cota√ß√£o** = vem do arquivo COTAHIST da B3 (arquivo TXT que parseia)
